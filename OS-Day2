------------------------------------------------------------------------------------------------------------------------
//COSC OS DAY 2 GENERAL LINKS
//CHANGE NAME OF TERMINAL: $host.UI.RawUI.WindowTitle = "System Information"
//CTRL + ARROWKEY WILL BRING YOU TO THE START OR BEGINNING OF A LINE
------------------------------------------------------------------------------------------------------------------------
REGISTRY HIVE MOUNTING VIA PSDRIVE:
  New-PSDrive -Name HKU -PSProvider Registry -Root HKEY_USERS
  /CREATE TEMPORARY OR PERMANENT CONENCTIONS TO NAVIGATE REGISTRY
  Get-PSDrive DISPLAYS EXISTING PSDRIVES 
  New-PSDrive -Name Demo -PSProvider FileSystem -Root c:\Demo
  /ANOTHER EXAMPLE DISPLAYING THE -name -psprovider -root REQUIREMENT OF THE CMDLET
  new-psdrive -persist SAVES THE DRIVE AND ENABLES PERSISTENCE

FORENSICALLY RELEVANT KEYS:
  INTERNET URL HISTORY
  USB HISTORY
  WIFI ACCESS POINT HISTORY

PERSISTENCE RELEVANT REGISTRY LOCATIONS:
  HKLM\Software\Microsoft\Windows\CurrentVersion\Run
  HKU\<SID>\Software\Microsoft\Windows\CurrentVersion\Run
  HKLM\SYSTEM\CurrentControlSet\services
  HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders
  HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders
  HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon

INTERESTING REGISTRY LOCATIONS:
  HKLM\BCD00000000
  /REPLACEMENT OF OLD boot.ini FILE
  HKLM\SAM\SAM
  /USE psexec -s -i regedit FROM administrator cmd.exe TO VIEW SAM
  HKU\<SID>\Software\Policies\Microsoft\Windows\System\Scripts
  /GROUP POLICY LOGIN/LOGOFF SCRIPTS DETERMINED HERE

BASELINING THE REGISTRY:
  Determining if the registry has been compromised
  Suspicious behavior
  Potenially malicious application removed from file system, but traces of application keep appearing
  Importance of baselining

REGISTRY HIVES:
  HKCR (HKEY_CLASSES_ROOT) - INFORMATION FROM HKLM + HKCU
  HKCU (HKEY_CURRENT_USER) - SYMBOLIC LINK OF THE HKU REGISTRY ENTRIES FOR THE USER CURRENTLY LOGGED IN, REMOVED UPON LOGOFF 
  HKLM (HKEY_LOCAL_MACHINE) - READ UPON BOOT!!! ALL HARDWARE CONFIGURATES, SAM, SECURITY, SYSTEM
  HKU  (HKEY_USERS) - REGISTRY CREATES TWO ENTRIES PER USER UPON THEIR LOGIN, ALSO INCLUDES ALL SYSTEM ACCOUNTS, INCLUDES LOTS OF SPECIFICS ON THAT INDIVIDUAL USER
  HKCC (HKEY_CURRENT_CONFIG) - SYMBOLIC LINK 

HOW THE HIVES RELATE AND CONNECT:
  HKU -> HKCU
  HHLM -> HKCC 

REGISTRY GENERAL INFO:
  MILLIONS OF ENTRIES 
  EACH ENTRY CONSISTS OF KEY-VALUE PAIR WITH VALUES AND POTENTIAL FOR SUBKEYS

REGISTRY POWERSHELL COMMANDS
  reg.exe/? DISPLAYS HELP FOR THE REGISTRY EDITOR
  reg query hklm\software\microsoft\windows\currentversion\run DISPLAYS THE SPECIFIED ENTRY FROM HKLM, A PERSISTENCE-RELEVANT LOCATION
  reg add hklm\software\microsoft\windows\currentversion\run /v test /t REG_SZ /d c:\Windows\system32\windowspowershell\v1.0\powershell.exe ADDS A KEY-VALUE PAIR TO THE ENTRY QUERRIED ON LINE 53
  reg delete hklm\software\microsoft\windows\currentversion\run /v test PROMPTS FOR CONFIRMATION AND THEN DELETES THE VALUE CREATED IN LINE 54

REGISTRY MANIPULATION: 
  QUERY:
    get-childitem GETS ITEMS IN ONE OR MORE SPECIFIED LOCATIONS, MORE OUTPUT
    Get-ItemProperty GETS ITEMS IN ONE OR MORE SPECIFIED LOCATIONS
    Get-Item GETS ONE ITEM IN ONE SPECIFIED LOCATION, DOES NOT RETURN CONTENTS  UNLESS WILDCARD * IS UTILIZED

  MODIFY:
    Set-ItemProperty HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run -Name Test -Value Bacon.exe
      EDITS VALUE OF AN EXISTING SUBKEY
    Remove-ItemProperty -Path "HKLM:\Software\Microsoft\Office\14.0\Security\Trusted Documents\TrustRecords" -Name "%USERPROFILE%Downloads/test-document.doc"
      REMOVES VALUE ASSOCIATED WITH A SUBKEY
    Rename-ItemProperty -Path HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run -Name SecurityHealth -NewName Test
      RENAMES A VALUE ASSOCIATED WITH A SUBKEY 

  CREATE:
    New-Item "HKLM:\software\microsoft\officecsp\14.0\security\trusted documents\trustedrecords" -force 
      ADDS A KEY WITHOUT A VALUE
    New-ItemProperty "HKLM:\Software\Microsoft\Office\14.0\Security\Trusted Documents\TrustRecords" -Name "%USERPROFILE%Downloads/test-document.doc" -PropertyType Binary -Value ([byte[]](0x30,0x31,0xFF))
      ADDS A VALUE TO THE KEY JUST CREATED

ALTERNATE DATA STREAM (ADS) NOTES
  ADDING AN ADS TO YOUR FILE DOES NOT CHANGE THE FILE HASH!!! THEREFORE HARDER TO DETECT
  CANNOT BE DISABLED, BUT CAN BE DELETED BY COPYING THE FILE TO A FAT32 FILESYSTEM
  set-content file.txt -value "new stuff" -stream secret.info ADDS A NEW STREAM TO THE FILE
  get-item file.txt -stream * LISTS ALL STREAMS FOR THE FILE
  get-content file.txt -stream secret.info DISPLAYS THE FILE'S CONTENTS THAT EXIST WITHIN THE SPECIFIED STREAM
  !!!IF MORE THAN ONE STREAM EXISTS, THIS MEANS THERE ARE ALTERNATE DATA STREAMS FOR THE FILE!!!

------------------------------------------------------------------------------------------------------------------------
CTFD CHALLENGES - 05_windows_registry
Primer_Registry_1 1
What Windows registry path is the Volatile Hive? Research: https://vistech.net/~champ/online-docs/books/mwin2reg/ch11-30975.html
  ANSWER: HKLM\HARDWARE
Primer_Registry_2 1
What registry key creates the Wow6432Node to represent 32-bit applications that run on a 64-bit version of Windows?
  ANSWER: HKEY_LOCAL_MACHINE\SOFTWARE
Primer_Registry_3 1
In what registry path are the BOOT_START drivers located?
  ANSWER: HKLM\SYSTEM\CurrentControlSet\Services
Primer_Registry_4 1
What start value do BOOT_START drivers have in the registry?
  ANSWER: 0x0
Primer_Registry_5 1
During kernel initialization, what registry location is read containing all SYSTEM_START drivers and services with a start value of 0x1?
  ANSWER: HKLM\SYSTEM\CurrentControlSet\Services
Primer_Registry_6 1
Auto_START drivers and services are loaded after kernel initialization. What start value do they have in the registry?
  ANSWER: 0x02
Primer_Registry_7 1
What start value do DEMAND_START drivers and services have in the registry?
  ANSWER: 0x3
Primer_Registry_8 1
When accessing a remote registry which are the only 2 accessible HKEYs? SYNTAX Hive, Hive
  ANSWER: HKLM, HKU
Primer_Registry_9 1
What PowerShell cmdlet will list currently mapped drives?
  ANSWER: get-psdrive
Primer_Registry_10 1
What is the native Windows GUI tool for managing the registry?
  ANSWER: Regedit
Windows_Registry_Basics_1 5
What registry hive contains all machine settings?
  ANSWER: HKLM
Windows_Registry_Basics_2 5
What registry hive contains all user settings?
  ANSWER: HKU
Windows_Registry_Basics_3 5
What registry hive contains only the currently logged-in user's settings?
  ANSWER: HKCU
Windows_Registry_Basics_4 5
The HKEY_CURRENT_USER registry hive is a symbolic link to another registry subkey. What is the subkey that it is linked to? Flag format: HIVE\SID.........................
  ANSWER: 
Windows_Registry_Basics_5 5
What PowerShell command will list all the subkeys and contents in the current directory and/or will list all the subkeys and the contents of a directory you specify?
  ANSWER: get-childItem
Windows_Registry_Basics_6 5
What PowerShell command will list only the contents of a registry key or subkey?
  ANSWER: get-item
Windows_Registry_Basics_7 10
What registry subkey runs every time the machine reboots? The flag is the full path, using PowerShell. Flag format: FULL\PATH\ALL\CAPS
  ANSWER: HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
Windows_Registry_Basics_8 10
What registry subkey runs every time a user logs on? The flag is the full path, using PowerShell. Flag format: FULL\PATH\ALL\CAPS
  ANSWER: HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
Windows_Registry_Basics_9 10
What registry subkey runs a single time, then deletes its value once the machine reboots? The flag is the full path, using PowerShell.
  ANSWER: HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUNONCE
Windows_Registry_Basics_10 10
What registry subkey runs a single time, then deletes its value when a user logs on? The flag is the full path, using PowerShell. Flag format: FULL\PATH\ALL\CAPS
  ANSWER: HKEY_CURRENT_USER\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUNONCE VIA https://learn.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys
Windows_Registry_Basics_11 15
What is the value inside of the registry subkey from your previous challenge named registry_basics_7?
  ANSWER: C:\malware.exe VIA reg query HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
Windows_Registry_Basics_12 15
What is the value inside of the registry subkey that loads every time the "Student" user logs on?





